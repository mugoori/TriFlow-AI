"""
{{ name }} Module - API Router
Generated by TriFlow Module Generator
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List
from uuid import UUID

from app.auth.dependencies import get_current_user
from app.database import get_db
from app.models.core import User
from app.shared.pagination import PaginatedResponse
from .service import {{ pascal_name }}Service
from .schemas import (
    {{ pascal_name }}Create,
    {{ pascal_name }}Update,
    {{ pascal_name }}Response
)

router = APIRouter()


@router.get("/", response_model=PaginatedResponse[{{ pascal_name }}Response])
async def list_{{ module_code }}(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    {% for field in fields %}
    {% if field.filterable %}
    {{ field.name }}: {{ field.python_type }} | None = None,
    {% endif %}
    {% endfor %}
    sort_by: str | None = None,
    sort_order: str = Query("asc", regex="^(asc|desc)$"),
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    {{ name }} 목록 조회
    페이지네이션, 필터링, 정렬 지원
    """
    service = {{ pascal_name }}Service(db)

    # Build filters
    filters = {}
    {% for field in fields %}
    {% if field.filterable %}
    if {{ field.name }} is not None:
        filters['{{ field.name }}'] = {{ field.name }}
    {% endif %}
    {% endfor %}

    # Get paginated results
    return await service.list_items_paginated(
        tenant_id=current_user.tenant_id,
        page=page,
        page_size=page_size,
        filters=filters,
        sort_by=sort_by,
        sort_order=sort_order
    )


@router.post("/", response_model={{ pascal_name }}Response, status_code=201)
async def create_{{ module_code }}(
    data: {{ pascal_name }}Create,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    {{ name }} 생성
    """
    service = {{ pascal_name }}Service(db)
    return await service.create(
        tenant_id=current_user.tenant_id,
        data=data.model_dump()
    )


@router.get("/{item_id}", response_model={{ pascal_name }}Response)
async def get_{{ module_code }}(
    item_id: UUID,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    {{ name }} 상세 조회
    """
    service = {{ pascal_name }}Service(db)
    item = await service.get_by_id(item_id, current_user.tenant_id)

    if not item:
        raise HTTPException(status_code=404, detail="{{ name }} not found")

    return item


@router.patch("/{item_id}", response_model={{ pascal_name }}Response)
async def update_{{ module_code }}(
    item_id: UUID,
    data: {{ pascal_name }}Update,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    {{ name }} 수정
    """
    service = {{ pascal_name }}Service(db)

    # Only update provided fields
    update_data = data.model_dump(exclude_unset=True)
    item = await service.update(item_id, current_user.tenant_id, update_data)

    if not item:
        raise HTTPException(status_code=404, detail="{{ name }} not found")

    return item


@router.delete("/{item_id}", status_code=204)
async def delete_{{ module_code }}(
    item_id: UUID,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """
    {{ name }} 삭제
    """
    service = {{ pascal_name }}Service(db)
    deleted = await service.delete(item_id, current_user.tenant_id)

    if not deleted:
        raise HTTPException(status_code=404, detail="{{ name }} not found")

    return None
