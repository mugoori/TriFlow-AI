# ===================================================
# TriFlow AI - Intent Routing Rules
# 라우팅 규칙 정의 (정규식 패턴 기반)
# ===================================================
"""
라우팅 규칙 정의 파일

이 파일에서 각 Agent의 라우팅 규칙을 관리합니다.
새로운 Agent 추가 시 이 파일에 규칙만 추가하면 됩니다.

우선순위(priority):
- 높을수록 우선 매칭
- bi(100) > learning(70) > workflow(60) > judgment(50) > general(0)
- 시각화 키워드가 있으면 bi가 우선
"""

from typing import Dict, List, Any

# Intent 타입 정의
INTENT_TYPES = [
    "judgment",   # 센서/라인 데이터 조회, 상태 확인
    "bi",         # 차트/그래프 생성, 데이터 분석 시각화
    "workflow",   # 자동화 워크플로우 생성/관리
    "learning",   # 규칙/룰셋 생성, 피드백 학습
    "general",    # 일반 질문/인사
]


ROUTING_RULES: Dict[str, Dict[str, Any]] = {
    # =========================================
    # Judgment Agent - 센서/라인 데이터 조회
    # =========================================
    "judgment": {
        "priority": 50,
        "description": "센서/라인 데이터 조회, 상태 확인, 실시간 모니터링",
        "patterns": [
            # 센서 데이터 조회
            r"(센서|온도|압력|습도|진동|유량).*(데이터|값).*(보여|조회|확인|알려)",
            r"(센서|온도|압력|습도|진동|유량).*(보여|조회|확인)",
            # 기간 + 데이터 조회
            r"\d+월.*(센서|데이터|현황)",
            r"(지난|이번|저번).*(주|달|월).*(센서|데이터)",
            r"(오늘|어제|최근).*(센서|데이터|상태)",
            # 라인/공장 상태
            r"(LINE_|라인|공장|설비).*(상태|데이터|현황)",
            r"(LINE_|라인).*(온도|압력|습도)",
            # 상태 확인
            r"(상태|현황).*(확인|체크|점검|알려)",
            r"(센서|온도|압력|습도).*(확인|체크|점검)",
            # 데이터 단순 조회
            r"데이터.*(보여|조회|가져)",
        ],
        "keywords": ["센서 데이터", "라인 상태", "온도 확인", "현재 상태"],
        "examples": [
            "11월달 센서 데이터 보여줘",
            "A라인 온도 데이터 확인",
            "지난주 압력 데이터 조회해줘",
            "현재 공장 상태 알려줘",
            "LINE_A 상태 어때?",
        ],
    },

    # =========================================
    # BI Planner Agent - 차트/분석/시각화
    # =========================================
    "bi": {
        "priority": 100,  # 시각화 키워드가 있으면 최우선
        "description": "차트/그래프 생성, 데이터 분석, 시각화, 리포트",
        "patterns": [
            # 시각화 명시
            r"(차트|그래프|대시보드|리포트).*(생성|만들|보여)",
            r".*(차트로|그래프로|시각화).*(보여|만들)",
            r"시각화",
            # 분석/통계
            r"(추이|트렌드|비교|통계).*(분석|보여)",
            r"(분석|비교).*(해줘|보여줘)",
            r"통계.*보여",
            # 리포트
            r"(리포트|보고서).*(생성|만들)",
            # 기간 + 분석
            r"\d+월.*(분석|통계|추이|비교)",
        ],
        "keywords": ["차트", "그래프", "대시보드", "추이 분석", "통계", "시각화"],
        "examples": [
            "11월달 센서 데이터를 차트로 보여줘",
            "온도 추이 그래프 만들어줘",
            "라인별 불량률 비교 대시보드",
            "지난달 생산량 통계 분석해줘",
        ],
    },

    # =========================================
    # Workflow Planner Agent - 자동화 워크플로우
    # =========================================
    "workflow": {
        "priority": 60,
        "description": "자동화 워크플로우 생성/수정/삭제, 트리거 설정",
        "patterns": [
            # 워크플로우 CRUD
            r"워크플로우.*(생성|만들|수정|삭제|추가)",
            r"(자동화|자동).*(설정|만들|워크플로우)",
            # 트리거/알림 자동화
            r"(알림|통보|경고).*(자동|트리거|보내)",
            r"(조건|~면|~시).*(자동|알림)",
            # 프로세스 자동화
            r"프로세스.*(자동화|설정)",
        ],
        "keywords": ["워크플로우", "자동화", "트리거", "자동 알림"],
        "examples": [
            "불량 발생 시 자동으로 알림 보내는 워크플로우 만들어줘",
            "온도 80도 넘으면 자동 알림 설정해줘",
            "새 워크플로우 생성해줘",
        ],
    },

    # =========================================
    # Learning Agent - 규칙/피드백 학습
    # =========================================
    "learning": {
        "priority": 70,
        "description": "규칙/룰셋 생성, 피드백 학습, 규칙 개선 제안",
        "patterns": [
            # 규칙/룰셋 생성
            r"(규칙|룰셋|룰|판단.?규칙).*(만들|생성|추가|수정|설정)",
            r"(판단|분류).*(규칙|기준).*(만들|설정)",
            # 조건부 규칙
            r".*(이상|초과|미만|이하).*시.*(경고|알림|위험|정상)",
            r".*(넘으면|되면|미만이면).*(경고|위험|알림)",
            # 피드백/학습
            r"피드백",
            r"(규칙|룰).*(개선|최적화|제안)",
            # 시뮬레이션
            r"시뮬레이션",
        ],
        "keywords": ["규칙 만들어", "룰셋", "피드백", "판단 규칙", "규칙 개선"],
        "examples": [
            "온도 80도 넘으면 경고, 90도 넘으면 위험으로 판단하는 규칙 만들어줘",
            "압력 10 이상이면 알림 보내는 룰셋 생성해줘",
            "이 판단이 맞는지 피드백해줘",
            "규칙을 개선할 수 있을까?",
        ],
    },

    # =========================================
    # General Assistant - 일반 질문/인사
    # =========================================
    "general": {
        "priority": 0,  # 가장 낮은 우선순위 (fallback)
        "description": "일반 질문, 인사, 도움말",
        "patterns": [
            # 인사
            r"^(안녕|하이|헬로|hello|hi)",
            r"(좋은|굿).*(아침|저녁|밤)",
            # 질문
            r"(뭐야|누구야|뭐니|누구니)",
            r"(도움말|help|도와줘)",
            r"(할 수 있|가능한).*(뭐|기능)",
            # 감사/마무리
            r"(고마워|감사|땡큐|thanks)",
        ],
        "keywords": ["안녕", "도움말", "뭐야", "누구야"],
        "examples": [
            "안녕",
            "넌 뭐야?",
            "도움말",
            "고마워",
        ],
    },
}


def get_rule(intent: str) -> Dict[str, Any]:
    """특정 Intent의 규칙 조회"""
    return ROUTING_RULES.get(intent, {})


def get_all_intents() -> List[str]:
    """모든 Intent 타입 조회"""
    return list(ROUTING_RULES.keys())


def get_sorted_rules() -> List[tuple]:
    """우선순위 순으로 정렬된 규칙 목록"""
    return sorted(
        ROUTING_RULES.items(),
        key=lambda x: x[1].get("priority", 0),
        reverse=True
    )
