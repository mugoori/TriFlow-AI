# D-3. Operation Runbook / Playbook

## 1. 정기 점검 체크리스트 (예시)
- 매일: 알람 대시보드 확인, LLM 실패율/비용, WF DLQ, MCP 타임아웃, DB/Redis 상태
- 매주: 슬로우 쿼리 리뷰/인덱스 조정, 캐시 적중률 점검, 로그 보존/스토리지 사용량 확인
- 매월: 백업 복구 리허설, 권한/Secret 검토, Rule/Prompt/DSL 변경 이력 리뷰
- 분기: DR 리허설, 회로차단/알람 정책 재점검, 보안 키 롤테이션 확인

## 2. 배포/롤백 절차 (상세)
1) 스테이징 배포 → 스모크(E2E 판단/알림/BI) → LLM 파싱/로그 확인  
2) Pre-prod 가용 시 Canary(10~20%) → 메트릭/알람 모니터(지연/에러/파싱 실패/비용)  
3) Prod Canary → 10~20분 관찰 → 문제 없으면 점진 확장 → 전체 롤아웃  
4) 실패 시: Helm rollback/이전 이미지 배포, DB 마이그 다운 스크립트 적용, 캐시 무효화 → 안정성 확인  
5) 배포 로그/릴리즈 노트/변경 이력 기록, 연관 알람/지표 확인

## 6. 배포/롤백 명령 예시 (Helm)
```bash
# 스테이징/프로드 배포
helm upgrade --install judgment ./charts/judgment -f values-prod.yaml --namespace prod
# 롤백
helm rollback judgment <REVISION>
# DB 마이그레이션(사전/사후)
alembic upgrade head
alembic downgrade -1   # 실패 시
```

## 7. DR 스위치백(정상 복귀) 절차
1) DR 경보 해제 조건 확인: 원 리전/DB 복구, 네트워크/보안 정상 확인.
2) 최신 데이터 동기화 여부 검사(증분 복제/로그 비교) 후 선택:
   - DR → 본 리전 증분만 역복제 또는
   - 본 리전으로 전환 후 DR을 스탠바이로 유지.
3) 트래픽 전환: DNS/Ingress를 본 리전으로 되돌림, 헬스체크 통과 확인.
4) 검증: 핵심 워크플로우/판단/BI 스모크, 로그/알람 정상 확인, 데이터 정합성 샘플링.
5) DR 리소스 축소 또는 대기상태로 전환, 보고서 작성(다운타임/영향/조치).

## 2. 배포 절차 (MVP)
1) 스테이징에 배포 → 스모크(E2E 판단/알림/BI) → LLM 파싱/로그 확인
2) 승인 후 프로덕션 Canary(10~20%) → 에러/지연/알람 모니터
3) 정상 시 전체 롤아웃, 문제 시 롤백(직전 이미지/DB 마이그 이전 상태)
4) 배포 결과/변경사항/릴리즈 노트 기록

## 3. 장애 대응 플레이북 (예시)
- **LLM 장애/타임아웃 증가**
  - 조치: 모델 스위치(저가형/온프레), fallback=RULE_ONLY, rate limit 조정
  - 확인: LLM 호출 로그, 비용/실패율, 판단 정확도 영향
- **MCP/커넥터 장애**
  - 조치: 회로차단 상태 확인 → 재시도/대체 노드 사용 → 수동 데이터 업로드 안내
  - 확인: MCP call 에러율, 워크플로우 실패 로그, 알람
- **3. 공정별 표준 작업 절차 (SOP Runbook 예시)**
  - **공정 시작 전 점검**: 안전 장구 착용, 설비 상태 확인, 작업 지시서 확인.
  - **공정 운전**: 표준 조건(온도/압력/속도) 설정, 가동 시작, 주기적 모니터링.
  - **이상 발생 시**: 즉시 가동 중지, 관리자 보고, 비상 조치 매뉴얼 준수.
  - **공정 종료**: 설비 정지, 청소/세척(CIP), 작업 일지 작성.
- **5. LLMOps & Learning Runbook (AI 운영)**
  - **Intent Rule 승격 (주간)**:
    1) `intent_logs`에서 Confidence < 0.8 이지만 정답 피드백(👍) 받은 발화 추출.
    2) 빈도수 상위 패턴(예: "~분석해줘" → `bi_insight`) 식별.
    3) Learning 탭에서 Rule 후보 등록 → 시뮬레이션(Zwave) → 배포.
  - **Prompt Tuning (월간)**:
    1) 오분류/미탐지(Confidence < 0.5) 로그 분석.
    2) 대표적인 실패 사례 3~5개를 프롬프트 Few-shot 예시에 추가.
    3) 프롬프트 버전 업데이트 및 카나리 배포.

- **6. 장애 유형별 대응 시나리오**
- **DB 성능 저하**
  - 조치: 슬로우 쿼리 확인, 연결수 제한, 캐시 TTL 단축, Pre-agg 활용 강제
  - 확인: DB CPU/IOPS 안정화, API 응답시간 정상화
- **잘못된 Rule 배포 (오경보 급증)**
  - 조치: 직전 버전 롤백, Zwave Replay로 영향 범위 확인, Learning 후보 보류재생성, 캐시 없는 상태로 degrade
  - 확인: hit/miss, latency, 연결 오류
- **룰/프롬프트 배포 후 오경보 폭증**
  - 조치: 직전 버전 롤백, Zwave Replay로 영향 범위 확인, Learning 후보 보류
  - 확인: 경보 카운트, 피드백, 품질 지표

## 4. 온콜/에스컬레이션
- 온콜 일정/담당 지정, L1→L2→L3(Dev) 경로
- 장애 분류: Sev1(서비스 중단), Sev2(부분 장애/성능 저하), Sev3(경미)
- 커뮤니케이션: 슬랙/전화, 사고 보고서 템플릿(RCA 포함), 고객사 통지 기준

## 5. 비상 복구 (DR)
- **트리거**: 리전/존 장애, DB 손상, 대규모 데이터 오염, 핵심 서비스 장기 중단
- **목표**: RTO 4h, RPO 30m (초안)
- **운영 절차 (체크리스트)**  
  1) DR 선언 및 온콜 소집 → 커뮤니케이션 채널 오픈(슬랙/전화)  
  2) 백업 무결성 확인(SHA/로그) → PITR 시점 결정(RPO 내)  
  3) DB 복구 실행(PITR/스냅샷) → 읽기/쓰기 헬스 체크 → 슬로우/에러 로그 점검  
  4) 애플리케이션 재기동/설정 동기화 → DNS/Ingress 전환 → 서비스 헬스 대시보드 확인  
  5) 데이터 정합성 점검: 핵심 테이블 샘플링, 판단/워크플로우 로그 조회, 캐시 클리어 후 재빌드  
  6) 비즈니스 검증: 대표 WF/판단/BI 스모크 실행 → 알람/로그 정상 여부 확인  
  7) 종료 보고: 영향 구간, 손실 데이터 유무, 후속 재발 방지 액션 기록
- **정기 점검**: 주 1회 DR 복구 리허설(샌드박스), 월 1회 실제 백업에서 랜덤 테이블 복구 테스트 및 보고

### DR 복구 후 샘플 검증 SQL
```sql
-- 판단 로그 최근 1일 건수
SELECT count(*) FROM judgment_executions
 WHERE created_at >= now() - interval '1 day';
-- WF 인스턴스 상태 분포
SELECT status, count(*) FROM workflow_instances
 WHERE started_at >= now() - interval '1 day'
 GROUP BY status;
-- 핵심 fact 무결성(라인 수 x 날짜)
SELECT date, line_code, count(*) FROM fact_daily_production
 WHERE date >= current_date - 7
 GROUP BY date, line_code;
```
## 8. 카나리 관찰 지표/전환 기준 (예시)
- 관찰 구간: 10~20분, 트래픽 10~20%
- 전환 조건: 에러율 < 1%, Judgment p95 < 1.5s, LLM 파싱 실패율 < 0.5%, WF 실패율 < 1%, 알람 없음
- 롤백 조건: 위 임계 초과 또는 MCP 타임아웃률 > 5%, 캐시 적중률 급락 < 20%
