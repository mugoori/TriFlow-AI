# D-4. User & Admin Guide - Enhanced

## 문서 정보
- **문서 ID**: D-4
- **버전**: 2.0 (Enhanced)
- **최종 수정일**: 2025-11-26
- **상태**: Draft
- **관련 문서**:
  - A-3 Use Case & User Story
  - B-4 API Interface Spec
  - D-2 Monitoring & Logging

## 목차
1. [시작하기](#1-시작하기)
2. [사용자 가이드](#2-사용자-가이드)
3. [관리자 가이드](#3-관리자-가이드)
4. [FAQ 및 트러블슈팅](#4-faq-및-트러블슈팅)

---

## 1. 시작하기

### 1.1 시스템 접속

**웹 대시보드**: https://app.factory-ai.com

**로그인**:
1. 이메일 주소 입력
2. 비밀번호 입력
3. "로그인" 버튼 클릭

**초기 비밀번호 변경**:
- 첫 로그인 시 비밀번호 변경 필요
- 비밀번호 규칙: 최소 8자, 대소문자/숫자/특수문자 포함

### 1.2 대시보드 개요

```
┌─────────────────────────────────────────────────────────┐
│  AI Factory Decision Engine                     [User ▼]│
├─────────────────────────────────────────────────────────┤
│  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐    │
│  │ Home │  │Judg. │  │ Work │  │  BI  │  │Admin │    │
│  └──────┘  └──────┘  └──────┘  └──────┘  └──────┘    │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐  ┌────────────────────────┐  │
│  │  실시간 생산 지표    │  │  최근 판단 결과        │  │
│  │  ┌────┬────┬────┐  │  │  ┌──────────────────┐ │  │
│  │  │생산│불량│OEE │  │  │  │ HIGH_DEFECT      │ │  │
│  │  │500 │ 5  │82% │  │  │  │ LINE-A, Conf:0.92│ │  │
│  │  └────┴────┴────┘  │  │  │ 👍 👎            │ │  │
│  └─────────────────────┘  │  └──────────────────┘ │  │
│                           └────────────────────────┘  │
├─────────────────────────────────────────────────────────┤
│  알림: 🚨 LINE-A 불량률 5% 초과 (16:30)                 │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 사용자 가이드

### 2.1 불량 판단 요청

**사용자**: 제조 현장 관리자, 품질 관리자

#### 2.1.1 웹 대시보드에서 판단 요청

**단계**:
1. **Judgment 페이지** 이동
2. **판단 요청 폼** 작성
   - 라인 코드: LINE-A (드롭다운 선택)
   - 날짜: 2025-11-26 (달력 선택)
   - 제품 코드: PROD-123 (선택적)
3. **"판단 실행"** 버튼 클릭
4. **결과 확인** (2초 이내)
   - 상태: HIGH_DEFECT
   - 심각도: Critical
   - 신뢰도: 0.92
   - 조치사항:
     - LINE-A 즉시 중단
     - 설비 점검 및 캘리브레이션
     - 최근 10개 배치 재검사
5. **상세 보기** 클릭 (선택적)
   - 판단 근거
   - 증거 데이터 (차트, 표)
   - 유사 과거 케이스
6. **피드백** 제공
   - 👍 Helpful: 판단이 정확했음
   - 👎 Not Helpful: 판단이 부정확했음
     - 코멘트 입력 (선택적): "실제로는 MODERATE_DEFECT였음"

**스크린샷**:
```
┌────────────────────────────────────────────────────┐
│  불량 판단 요청                            [✕ 닫기] │
├────────────────────────────────────────────────────┤
│  라인 코드: [LINE-A     ▼]                         │
│  날짜:      [2025-11-26   📅]                      │
│  제품 코드: [PROD-123   ▼] (선택)                  │
│                                                    │
│              [판단 실행]                            │
├────────────────────────────────────────────────────┤
│  결과:                                             │
│  ┌──────────────────────────────────────────────┐ │
│  │ 🚨 HIGH_DEFECT (Critical)                    │ │
│  │ 신뢰도: 0.92                                  │ │
│  │                                               │ │
│  │ 조치사항:                                     │ │
│  │ • LINE-A 즉시 중단                            │ │
│  │ • 설비 점검 및 캘리브레이션                    │ │
│  │                                               │ │
│  │ [상세 보기]  [👍 Helpful]  [👎 Not Helpful]  │ │
│  └──────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────┘
```

#### 2.1.2 Slack에서 판단 요청

**단계**:
1. Slack 채널 (#factory-ai) 또는 DM에서 멘션
   ```
   @AI-Factory LINE-A 불량 판단
   ```
2. **Intent 분류** (자동)
   - Intent: defect_inquiry
   - Slot: line_code=LINE-A
3. **Slot 누락 시 되묻기**
   ```
   어떤 날짜의 생산 데이터를 조회할까요?
   (예: 어제, 오늘, 2025-11-26)
   ```
4. **사용자 응답**
   ```
   어제
   ```
5. **Judgment 실행 및 결과** (Slack Block Kit)
   ```
   🚨 High Defect Detected

   Line: LINE-A
   Date: 2025-11-25
   Defect Rate: 5.0%
   Confidence: 0.92

   Recommended Actions:
   • Stop LINE-A immediately
   • Inspect equipment calibration

   [👍 Helpful] [👎 Not Helpful]
   ```

---

### 2.2 Workflow 생성 및 실행

**사용자**: AI 엔지니어, 시스템 관리자

#### 2.2.1 Workflow 생성 (Visual Editor)

**단계**:
1. **Workflow 페이지** 이동
2. **"새 워크플로우"** 버튼 클릭
3. **노드 추가** (드래그 앤 드롭)
   - 왼쪽 팔레트에서 노드 선택 (DATA, JUDGMENT, MCP, ACTION 등)
   - 캔버스에 드롭
4. **노드 연결** (Edge)
   - 시작 노드 출력 → 다음 노드 입력
5. **노드 설정**
   - 각 노드 클릭 → 설정 폼 작성
   - 예: DATA 노드
     - 테이블: fact_daily_production
     - 컬럼: line_code, defect_count, production_count
     - 필터: date = {{ input.date }}
6. **DSL 검증**
   - "검증" 버튼 클릭
   - 에러 있으면 수정
7. **저장**
   - 워크플로우 이름 입력
   - "저장" 버튼
   - 버전 자동 부여 (v1.0.0)

**스크린샷**:
```
┌────────────────────────────────────────────────────────────┐
│  Workflow Editor: RCA Workflow                  [저장] [✕] │
├────────────────────────────────────────────────────────────┤
│  ┌──────────────┐                  ┌────────────────────┐ │
│  │ 노드 팔레트  │                  │      캔버스        │ │
│  ├──────────────┤                  ├────────────────────┤ │
│  │ 📊 DATA      │                  │  ┌───────────┐    │ │
│  │ ⚖️  JUDGMENT │                  │  │  start    │    │ │
│  │ 🔧 MCP       │                  │  │  (DATA)   │    │ │
│  │ 📧 ACTION    │                  │  └─────┬─────┘    │ │
│  │ 🔀 SWITCH    │                  │        ▼          │ │
│  │ ⏸️  WAIT      │                  │  ┌─────────────┐  │ │
│  └──────────────┘                  │  │  judgment   │  │ │
│                                    │  │ (JUDGMENT)  │  │ │
│                                    │  └─────┬───────┘  │ │
│                                    │        ▼          │ │
│                                    │  ┌─────────────┐  │ │
│                                    │  │   notify    │  │ │
│                                    │  │  (ACTION)   │  │ │
│                                    │  └─────────────┘  │ │
│                                    └────────────────────┘ │
├────────────────────────────────────────────────────────────┤
│  노드 설정: judgment                                        │
│  Type: JUDGMENT                                           │
│  Workflow ID: [jud-defect-001 ▼]                          │
│  Input Mapping:                                           │
│  - line_code: {{ nodes.start.line_code }}                 │
│  - defect_count: {{ nodes.start.defect_count }}           │
│                                                            │
│  [저장] [취소]                                              │
└────────────────────────────────────────────────────────────┘
```

#### 2.2.2 Workflow 실행

**단계**:
1. Workflow 목록에서 선택
2. "실행" 버튼 클릭
3. 입력 데이터 입력
   ```json
   {
     "line_code": "LINE-A",
     "date": "2025-11-26"
   }
   ```
4. 실행 상태 모니터링
   - PENDING → RUNNING → COMPLETED
   - 진행률 표시 (노드별)
5. 결과 확인
   - 각 노드 출력 데이터
   - 실행 시간
   - 성공/실패 여부

---

### 2.3 BI 자연어 쿼리

**사용자**: 데이터 분석가, 품질 관리자, 경영진

#### 2.3.1 자연어 쿼리 실행

**단계**:
1. **BI 분석 페이지** 이동
2. **질의 입력**
   ```
   지난 7일간 LINE-A의 일별 생산량과 불량률을 보여줘
   ```
3. **엔터** 키 또는 **"분석"** 버튼 클릭
4. **차트 확인** (2~3초 이내)
   - Line Chart (일별 생산량)
   - Line Chart (일별 불량률)
   - X축: 날짜
   - Y축: 생산량 (왼쪽), 불량률 (오른쪽 %)
5. **추가 작업** (선택적)
   - 대시보드에 추가
   - CSV 다운로드
   - 이미지 저장 (PNG)
   - 공유 링크 생성

**예시 질의**:
- "오늘 전체 라인 불량률"
- "지난 달 OEE 트렌드"
- "라인별 평균 생산량 비교"
- "PROD-123의 주간 불량 통계"

**스크린샷**:
```
┌────────────────────────────────────────────────────────────┐
│  BI 분석                                        [+ 대시보드] │
├────────────────────────────────────────────────────────────┤
│  질의: [지난 7일간 LINE-A 일별 생산량과 불량률] [분석]     │
├────────────────────────────────────────────────────────────┤
│  결과 (2.3초):                                             │
│  ┌────────────────────────────────────────────────────────┐│
│  │        LINE-A 일별 생산량 및 불량률                     ││
│  │  600┤                                      ┌─ 생산량   ││
│  │     │                        ●            │            ││
│  │  500┤              ●      ●     ●         │            ││
│  │     │          ●       ●           ●      │            ││
│  │  400┤      ●                               │            ││
│  │     ├──────────────────────────────────────┤            ││
│  │    2%│  ●  ●                    ●     ●   └─ 불량률(%) ││
│  │    1%│        ●  ●  ●  ●  ●                            ││
│  │     └────────────────────────────────────────           ││
│  │      11/19 11/21 11/23 11/25                           ││
│  └────────────────────────────────────────────────────────┘│
│  [CSV 다운로드] [PNG 저장] [공유]                          │
└────────────────────────────────────────────────────────────┘
```

---

## 3. 관리자 가이드

### 3.1 사용자 관리

**담당**: System Admin

#### 3.1.1 사용자 생성

**단계**:
1. **Admin → 사용자 관리** 이동
2. **"새 사용자"** 버튼 클릭
3. **사용자 정보** 입력
   - 이메일: user@company.com
   - 이름: 홍길동
   - 역할: Manager (드롭다운)
4. **"생성"** 버튼
5. **초기 비밀번호** 이메일 발송

#### 3.1.2 권한 변경

**단계**:
1. 사용자 목록에서 선택
2. **"권한 수정"** 버튼
3. 역할 변경 (Operator → Manager)
4. **"저장"** 버튼
5. 감사 로그 자동 기록

### 3.2 커넥터 설정

**담당**: System Admin, IT Manager

#### 3.2.1 ERP/MES DB 커넥터 등록

**단계**:
1. **Admin → 커넥터** 이동
2. **"새 커넥터"** 버튼
3. **커넥터 정보** 입력
   - 이름: ERP Database
   - 타입: PostgreSQL (드롭다운)
   - 호스트: erp-db.company.com
   - 포트: 5432
   - 데이터베이스: erp_prod
   - 사용자: readonly_user
   - 비밀번호: \*\*\*\*\*\*\*\*
   - SSL 모드: require
4. **"연결 테스트"** 버튼
   - 성공: ✅ 연결 성공 (35ms)
   - 실패: ❌ 연결 실패 (에러 메시지)
5. **"저장"** 버튼

#### 3.2.2 헬스 체크 설정

**단계**:
1. 커넥터 상세 페이지
2. **"헬스 체크 설정"** 탭
3. **설정 입력**
   - 주기: 5분
   - 쿼리: SELECT 1
   - 타임아웃: 10초
   - 실패 임계: 3회 연속
4. **"저장"** 버튼

**헬스 체크 상태**:
```
┌────────────────────────────────────────────┐
│  커넥터 상태                               │
├────────────────────────────────────────────┤
│  ✅ ERP Database        (Healthy, 35ms)   │
│  ✅ MES API             (Healthy, 120ms)  │
│  ⚠️  Sensor MQTT        (Degraded, 2s)    │
│  ❌ Legacy Excel Server (Unhealthy)       │
└────────────────────────────────────────────┘
```

### 3.3 Rule 배포 (Canary)

**담당**: AI Engineer

#### 3.3.1 Rule 생성 및 배포

**단계**:
1. **Learning → Rule 후보** 이동
2. **자동 추출된 Rule** 선택
   - Rule 이름: Auto Defect Detection v2
   - Precision: 0.92
   - Recall: 0.85
   - F1 Score: 0.88
3. **Rule 코드 검토**
   ```rust
   let defect_rate = input.defect_count / input.production_count;

   if defect_rate > 0.05 {
       #{ status: "HIGH_DEFECT", confidence: 0.90 }
   } else {
       #{ status: "NORMAL", confidence: 0.80 }
   }
   ```
4. **"승인"** 버튼 (Manager/Admin만 가능)
5. **"Canary 배포"** 버튼
6. **Canary 설정**
   - 트래픽 비율: 10%
   - 지속 시간: 60분
   - 성공 기준:
     - 에러율 < 1%
     - 정확도 > 85%
     - P95 < 2.5초
7. **"배포 시작"** 버튼
8. **실시간 모니터링**
   - 메트릭 대시보드 (에러율, 정확도, 지연)
   - 60분 경과 후 자동 승격 또는 롤백
9. **배포 완료 알림** (Slack)

---

## 4. FAQ 및 트러블슈팅

### 4.1 FAQ (자주 묻는 질문)

#### Q1: 판단 응답이 느려요 (> 5초)

**원인**:
- LLM API 지연
- 캐시 미스
- DB 슬로우 쿼리

**해결**:
1. **캐시 상태 확인**
   - Grafana → Cache Hit Rate 확인
   - 목표: > 40%
2. **LLM 상태 확인**
   - OpenAI Status: https://status.openai.com/
3. **임시 조치**: Rule Only 모드로 전환
   - Workflow 설정 → Policy: RULE_ONLY
4. **장기 조치**: 프롬프트 최적화, 모델 변경

---

#### Q2: LLM JSON 파싱 실패

**증상**:
- 에러 메시지: "Failed to parse LLM response"
- 500 Internal Server Error

**원인**:
- LLM이 잘못된 JSON 반환
- 프롬프트 템플릿 오류

**해결**:
1. **LLM 호출 로그 확인**
   ```sql
   SELECT
     input_prompt,
     response_text,
     error_message
   FROM llm_calls
   WHERE status = 'parsing_failed'
   ORDER BY created_at DESC
   LIMIT 10;
   ```
2. **프롬프트 템플릿 확인**
   - Admin → Prompts → 해당 템플릿 조회
   - JSON 스키마 명확히 명시 확인
3. **재시도** (자동 3회)
4. **Fallback**: Rule 결과 사용

---

#### Q3: MCP 도구 호출 실패

**증상**:
- Workflow 실행 실패 (MCP 노드에서 중단)
- 에러: "MCP server timeout"

**원인**:
- MCP 서버 다운
- 네트워크 문제
- Circuit Breaker OPEN

**해결**:
1. **MCP 서버 상태 확인**
   - Admin → MCP 서버 → 헬스 체크
2. **Circuit Breaker 상태 확인**
   ```promql
   circuit_breaker_state{server_id="mcp-excel"}
   ```
3. **수동 리셋** (필요 시)
   ```bash
   curl -X POST https://api.factory-ai.com/api/v1/mcp/circuit-breaker/reset \
     -H "Authorization: Bearer $TOKEN" \
     -d '{"server_id": "mcp-excel"}'
   ```
4. **Fallback 노드 설정** (Workflow 수정)

---

#### Q4: 알람이 너무 많아요 (오경보)

**원인**:
- Rule 임계값이 너무 낮음
- Hybrid Policy 가중치 부적절
- 데이터 품질 문제

**해결**:
1. **피드백 분석**
   ```sql
   SELECT
     result->>'status' AS status,
     AVG(CASE WHEN feedback_value = 'thumbs_up' THEN 1 ELSE 0 END) AS accuracy
   FROM judgment_executions j
   LEFT JOIN feedbacks f ON f.execution_id = j.id
   WHERE j.executed_at >= NOW() - INTERVAL '7 days'
   GROUP BY result->>'status';
   ```
2. **Rule 임계값 조정**
   - Learning → Rule 편집
   - 예: 불량률 임계값 2% → 3% (완화)
3. **Zwave Simulation** (영향도 확인)
   - 과거 7일 데이터로 재실행
   - 알람 감소 효과 확인
4. **Canary 배포** (조정된 Rule)

---

## 결론

본 문서(D-4)는 **AI Factory Decision Engine** 의 사용자 및 관리자 가이드를 상세히 작성하였다.

### 주요 성과
1. **사용자 가이드**: Judgment 요청, Workflow 실행, BI 쿼리 (스크린샷 포함)
2. **관리자 가이드**: 사용자 관리, 커넥터 설정, Rule 배포
3. **FAQ**: 4가지 자주 묻는 질문 및 해결 방법
4. **트러블슈팅**: 증상 → 원인 → 해결 단계별 가이드

### 다음 단계
1. 사용자 교육 자료 작성 (PPT, 동영상)
2. 온보딩 체크리스트 작성
3. 고객사 피드백 수집 및 가이드 개선

---

## 문서 이력
| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2025-11-08 | Product Team | 초안 작성 |
| 2.0 | 2025-11-26 | Product Team | Enhanced 버전 (스크린샷, FAQ, 트러블슈팅 추가) |
