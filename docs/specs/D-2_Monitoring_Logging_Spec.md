# D-2. Monitoring & Logging Spec

## 1. 모니터링 지표
- **서비스 지연/에러**: Judgment p50/p95, WF 노드 체류, BI 쿼리 시간, API 5xx/4xx
- **Intent/Learning**: 의도 분류 정확도(피드백 기반), 룰 추출 성공률, 카탈로그 사용 빈도
- **LLM**: 호출 성공률, 파싱 실패율, 토큰/비용, 모델별 분포
- **캐시/스토리지**: Redis hit/miss, evict/latency; DB QPS/슬로우 쿼리; Pre-agg 리프레시 상태
- **WF**: 인스턴스 상태 분포, 재시도/실패율, DLQ 건수, 승인 대기 시간, 회로차단 이벤트
- **커넥터/MCP**: 호출 성공률, 타임아웃, 회로차단 상태, 헬스체크 실패
- **인프라**: CPU/Mem/네트워크/디스크, 컨테이너 재시작 수

## 2. SLO/알람 조건 (예시)
- Judgment p95 > **1.5s** 5분 연속 → 알람 + HPA 스케일아웃/LLM 프롬프트 축소(옵션)
- LLM 파싱 실패율 > **1%** → 모델 스위치/재시도 정책 가동
- WF 실패율 > **2%** 또는 DLQ > **10/min** → 온콜 호출, 회로차단 상태 점검
- MCP 타임아웃률 > **5%** → 회로차단 켜고 대체 경로/수동 업로드 안내
- DB 슬로우 쿼리 > **500ms** 50회/5분 → 슬로우로그 캡처/쿼리 튜닝 작업 생성
- 비용: 일일 LLM 예산 80% 초과 → 알람, 저가형 모델 강제 전환 옵션

## 3. 로그 수집/보관 전략
- **구조화 로그(JSON)**: trace_id/request_id/tenant_id 포함, level/ts/service
- **카테고리**: app 로그, judgment_trace, workflow_log, llm_call, audit_log, access_log, webhook_log
- **보관**: 핫 30~90일, 콜드 2년(감사/CCP)까지; PII 마스킹 필수
- **도구**: Loki/ELK + Grafana/Kibana; 로그 샘플링(대량) + 중요 이벤트는 항상 저장

## 4. 트레이싱
- OpenTelemetry: HTTP/gRPC span, Redis/DB/MCP 호출 포함
- 샘플링: 기본 10~20%, 오류/슬로우 요청은 전량
- 대시보드: 서비스 토폴로지, 실패 경로, 슬로우 스팬 상위 N

## 5. 리포팅/대시보드 & 액션 매핑
- 운영 대시보드: 서비스 상태/알람 요약, LLM/캐시/DB 핵심 지표, MCP 헬스
- 품질 대시보드: 판단 정확도, 오경보/미탐지 비율, 피드백 추이, Replay 결과
- 배포/변경 대시보드: 최근 릴리즈/롤백/실패율, 영향 알람
- **알람→액션**: 온콜 호출 → 자동 스케일/회로차단/모델 전환/캐시 TTL 조정(정책화)

## 6. SLO / 알람-액션 표 (예시)
| 항목 | 목표(SLO) | 알람 임계 | 자동 액션 |
| --- | --- | --- | --- |
| Judgment p95 | ≤ 1.5s | 5분 연속 >1.5s | HPA 스케일아웃, LLM 프롬프트 축소 옵션 |
| LLM 파싱 실패율 | < 0.5% | 5분 1% 초과 | 대체 모델 전환, 재시도 횟수 증가 |
| WF 실패율 | < 1% | 5분 2% 초과 | 회로차단 on, DLQ 조사 태스크 생성 |
| MCP 타임아웃률 | < 3% | 5분 5% 초과 | 해당 노드 차단/대체 경로, 알림 |
| Redis hit ratio | > 40% | 10분 < 30% | TTL 조정/프리워밍 태스크 |
| LLM 비용 | 예산 100%/일 | 80% 도달 | 저가형 모델 강제, 알림 |
| Drift/충돌 감지 | - | drift 알람 발생 시 | 재학습 태스크/승인 요청 |
| 스키마 변경 | - | 커넥터/MCP 스키마 해시 변경 | ETL 중단/승인 대기, 알림 |

## 8. 캐나리/릴리즈 모니터링
- 관찰 지표: 에러율, Judgment p95, LLM 파싱 실패율, WF 실패율, MCP 타임아웃, 캐시 적중, 비용/토큰.
- 관찰 기간/전환 조건은 D-3의 카나리 기준과 동일하게 사용(10~20분, 임계 미충족 시 롤백).

## 7. 추적성 체크리스트 (모니터링 ↔ 요구/테스트/운영)
- Judgment/LLM 지표: A-2 JUD-FR/NFR ↔ B-2/B-4 Judgment ↔ C-3 TC-JUD ↔ 알람(지연/파싱/비용).
- WF 지표: A-2 WF-FR ↔ B-5 DSL/노드 ↔ C-3 TC-WF ↔ 알람(실패율/회로차단/DLQ).
- BI 지표: A-2 BI-FR ↔ B-2/B-4 BI ↔ C-3 TC-BI ↔ 알람(BI 지연).
- MCP/커넥터 지표: A-2 INT/DATA-FR ↔ B-4 MCP/Connector ↔ C-3 TC-MCP ↔ 알람(타임아웃/회로차단).
- 보안/감사: A-2 SEC/OBS-FR ↔ C-5 보안 ↔ B-3 audit_logs ↔ 알람(Webhook HMAC 실패 등).
- DR: A-2 DR-FR ↔ D-3 DR runbook ↔ 알람(DR 트리거 지표).
