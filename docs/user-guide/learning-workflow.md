# Learning Workflow 사용자 가이드

TriFlow AI 학습 파이프라인 사용법을 단계별로 안내합니다.

---

## 📚 목차

1. [개요](#개요)
2. [시작하기 - 설정](#시작하기---설정)
3. [단계별 워크플로우](#단계별-워크플로우)
4. [Best Practices](#best-practices)
5. [문제 해결](#문제-해결)

---

## 개요

### Learning Pipeline이란?

TriFlow AI는 **사용자 피드백으로부터 자동으로 학습**하여 판단 규칙을 개선하는 시스템입니다.

```
사용자 피드백 제공
  ↓
자동 샘플 추출 (6시간마다)
  ↓
Approver 샘플 검토 및 승인
  ↓
골든셋 자동 업데이트 (24시간마다)
  ↓
규칙 추출 (Decision Tree 학습)
  ↓
후보 테스트 및 승인
  ↓
ProposedRule 생성 → 배포
  ↓
더 나은 판단 → 긍정적 피드백 증가 🔄
```

### 주요 장점

- ✅ **자동화**: 피드백 → 샘플 → 규칙 자동 생성
- ✅ **품질 관리**: 품질 점수 기반 필터링
- ✅ **중복 제거**: MD5 해시 기반 중복 샘플 방지
- ✅ **검증**: 후보 규칙 테스트 후 승인
- ✅ **지속적 개선**: 데이터가 쌓일수록 규칙 개선

---

## 시작하기 - 설정

### 1. Settings 페이지 이동

좌측 메뉴에서 **Settings** 클릭 → **학습 파이프라인 설정** 섹션으로 스크롤

### 2. 학습 설정 구성

#### 샘플 큐레이션 설정

| 설정 항목 | 기본값 | 설명 |
|----------|--------|------|
| **최소 품질 점수** | 0.6 | 이 점수 이상의 샘플만 학습에 사용 |
| **자동 추출 활성화** | OFF | 피드백에서 자동으로 샘플 추출 |
| **추출 주기** | 6시간 | 자동 추출 실행 간격 (1-24시간) |

**권장 설정**:
- 초기 단계: 품질 점수 0.5 (다양한 샘플 수집)
- 안정화 단계: 품질 점수 0.7 (고품질 샘플만)

#### 규칙 추출 설정

| 설정 항목 | 기본값 | 설명 |
|----------|--------|------|
| **최대 트리 깊이** | 5 | Decision Tree 복잡도 (3-10) |
| **최소 분할 샘플** | 20 | 노드 분할에 필요한 최소 샘플 수 |

**권장 설정**:
- 샘플 부족 (<100개): max_depth=3, min_samples_split=10
- 샘플 충분 (>500개): max_depth=7, min_samples_split=30

#### 골든 샘플셋 설정

| 설정 항목 | 기본값 | 설명 |
|----------|--------|------|
| **자동 업데이트 활성화** | OFF | 고품질 샘플 자동 추가 |
| **업데이트 임계값** | 50 | 승인된 샘플이 이 수에 도달하면 업데이트 |

### 3. 설정 저장

**설정 저장** 버튼 클릭 (Admin 권한 필요)

---

## 단계별 워크플로우

### Step 1: 피드백 수집 📝

**역할**: 모든 사용자

사용자가 AI 판단 결과에 피드백을 제공합니다.

**방법**:
1. Chat 페이지에서 AI 응답 확인
2. 엄지 아이콘 클릭 (👍 긍정적 / 👎 부정적)
3. 피드백 모달에서:
   - 피드백 타입 선택 (개선 필요 / 수정 제안)
   - 이유 선택 (정보 틀림, 부족함, 관련 없음 등)
   - 코멘트 작성
   - (수정 제안인 경우) 올바른 답변 입력
4. 제출

**Tips**:
- 구체적인 피드백일수록 학습 품질 향상
- "수정 제안" 타입이 학습에 가장 유용함

---

### Step 2: 샘플 추출 🔍

**역할**: Operator, Approver, Admin

피드백에서 학습 샘플을 생성합니다.

#### 자동 추출 (권장)

1. Settings → **자동 추출 활성화** ON
2. 6시간마다 자동으로 실행
3. Learning 페이지에서 결과 확인

#### 수동 추출

1. Learning 페이지 → **학습 샘플 관리** 섹션
2. **샘플 추출** 버튼 클릭
3. 설정:
   - 과거 N일 피드백: 7일 (기본값)
   - 미리보기 모드: OFF
   - 최소 품질 점수: 0.6
4. **추출 시작** 클릭

**결과**:
- 추출된 샘플 수
- 중복 건너뛴 수
- 샘플 목록

---

### Step 3: 샘플 검토 및 승인 ✅

**역할**: Approver, Admin

추출된 샘플의 품질을 검토하고 승인합니다.

**방법**:
1. Learning 페이지 → **학습 샘플 관리** → 샘플 목록
2. 샘플 클릭 → 상세 모달 열림
3. 내용 확인:
   - 입력 데이터 (센서 값)
   - 예상 출력 (올바른 판단 결과)
   - 품질 점수
   - 소스 (피드백, 검증, 수동)
4. 판단:
   - **승인**: 학습에 사용 가능
   - **거절**: 이유 입력 후 거절
   - **수정**: 내용 수정 후 재검토

**승인 기준**:
- ✅ 입력 데이터가 실제 센서 값과 일치
- ✅ 예상 출력이 정확함
- ✅ 품질 점수 ≥ 0.6
- ✅ 중복되지 않은 고유한 케이스

---

### Step 4: 골든 샘플셋 관리 🏆

**역할**: Approver, Admin

고품질 샘플을 골든셋으로 큐레이션합니다.

#### 자동 업데이트 (권장)

1. Settings → **골든셋 자동 업데이트** ON
2. 24시간마다 자동으로:
   - 품질 점수 ≥ min_quality_score 샘플 추가
   - 품질 미달 샘플 제거 (선택적)
   - max_samples 제한 준수

#### 수동 관리

1. Learning 페이지 → **골든 샘플셋** 탭
2. 골든셋 생성:
   - 이름: "Production Quality Samples"
   - 카테고리: threshold_adjustment (선택)
   - 최소 품질 점수: 0.8
   - 최대 샘플 수: 100
3. 샘플 추가:
   - 샘플 목록에서 선택
   - **골든셋에 추가** 버튼 클릭

**골든셋 용도**:
- 규칙 추출 시 우선적으로 사용
- 모델 재학습 기준 데이터
- 품질 벤치마크

---

### Step 5: 규칙 추출 🎯

**역할**: Approver, Admin

승인된 샘플에서 Decision Tree를 학습하고 Rhai 규칙을 생성합니다.

**방법**:
1. Learning 페이지 → **규칙 추출** 섹션
2. **규칙 추출 시작** 버튼 클릭
3. 설정:
   - 카테고리: threshold_adjustment (또는 전체)
   - 최소 샘플 수: 20
   - 최대 트리 깊이: 5
   - 최소 분할 샘플: 20
4. **추출 시작** 클릭

**결과**:
- 후보 규칙 ID
- 생성된 Rhai 코드
- 성능 메트릭:
  - Coverage: 85% (규칙이 처리 가능한 케이스 비율)
  - Precision: 82% (규칙이 맞다고 한 것 중 실제 정확도)
  - Recall: 78% (실제 정답 중 규칙이 찾은 비율)
  - F1 Score: 80% (종합 점수)
- 특성 중요도 (어떤 센서가 중요한지)

**최소 요구사항**:
- 승인된 샘플 ≥ 20개
- Coverage ≥ 0.7 (70%)
- F1 Score ≥ 0.75 (75%)

---

### Step 6: 후보 테스트 및 승인 🧪

**역할**: Approver, Admin

생성된 규칙 후보를 검증하고 승인합니다.

#### 테스트

1. 규칙 후보 목록에서 후보 클릭
2. **테스트** 탭 선택
3. 테스트 샘플 입력:
   - 직접 입력 또는
   - 기존 샘플 선택
4. **테스트 실행** 클릭
5. 결과 확인:
   - 예상 결과 vs 실제 결과
   - 정확도
   - 신뢰도

#### 승인

1. 테스트 결과 만족하면 **승인** 버튼 클릭
2. 정보 입력:
   - 규칙 이름: "Temperature-based Warning Rule"
   - 설명: "Extracted from 120 samples, F1=0.82"
   - 즉시 배포: OFF (권장)
3. **승인** 클릭

**결과**:
- ProposedRule 생성 (status=pending)
- Builder 페이지에서 최종 검토 가능
- 배포 워크플로우로 이동

---

## Best Practices

### 샘플 수집 단계

1. **피드백 품질이 중요합니다**
   - ❌ 나쁨: "틀렸어요"
   - ✅ 좋음: "온도가 75°C인데 경고가 나와야 하는데 정상으로 표시됨"

2. **다양한 케이스 수집**
   - 정상, 경고, 위험 케이스 골고루
   - Edge case (경계값) 포함
   - 시간대, 라인별 다양성

3. **품질 점수 관리**
   - 초기: 0.5 (다양성 우선)
   - 성숙기: 0.7-0.8 (품질 우선)

### 규칙 추출 단계

1. **충분한 샘플 확보**
   - 최소: 20개
   - 권장: 100개 이상
   - 이상적: 500개 이상

2. **카테고리별 분리 학습**
   - threshold_adjustment: 임계값 관련
   - field_correction: 필드 오류 수정
   - validation_failure: 검증 실패

3. **메트릭 확인**
   - Coverage < 0.5: 샘플 부족 또는 너무 다양함
   - Precision < 0.7: 규칙이 너무 단순함
   - Recall < 0.7: 규칙이 너무 엄격함

### 골든셋 관리

1. **카테고리별 골든셋 생성**
   ```
   - "Threshold Tuning Golden Set" (threshold_adjustment)
   - "Field Correction Golden Set" (field_correction)
   - "General Cases Golden Set" (general)
   ```

2. **품질 기준**
   - 일반 샘플: quality_score ≥ 0.6
   - 골든셋: quality_score ≥ 0.8

3. **주기적 갱신**
   - 자동 업데이트 ON
   - 매주 수동 검토 권장

---

## 문제 해결

### 샘플 추출 시

#### 문제: 추출된 샘플이 너무 적음

**원인**:
- 피드백 로그가 부족함
- min_quality_score가 너무 높음
- 대부분 중복 샘플

**해결**:
1. Settings → 최소 품질 점수 낮춤 (0.5로)
2. 더 많은 피드백 수집 (사용자 유도)
3. 추출 기간 늘림 (7일 → 14일)

#### 문제: 중복 샘플이 많음

**원인**: 같은 입력/출력 조합의 피드백 반복

**해결**:
- 정상 동작 (중복 제거는 의도된 기능)
- 다양한 케이스에 대한 피드백 유도

---

### 규칙 추출 시

#### 문제: Coverage가 낮음 (<0.5)

**원인**:
- 샘플이 너무 다양함 (패턴 학습 어려움)
- 샘플 수 부족

**해결**:
1. 카테고리별로 분리 추출
2. 더 많은 샘플 수집 (>100개)
3. min_samples 낮춤 (20 → 10)

#### 문제: Precision이 낮음 (<0.7)

**원인**:
- 규칙이 너무 단순함
- max_depth가 낮음

**해결**:
1. Settings → 최대 트리 깊이 증가 (5 → 7)
2. 고품질 샘플만 사용 (quality ≥ 0.7)

#### 문제: Recall이 낮음 (<0.7)

**원인**:
- 규칙이 너무 엄격함
- min_samples_split이 높음

**해결**:
1. Settings → 최소 분할 샘플 감소 (20 → 10)
2. 다양한 케이스 샘플 추가

---

### 골든셋 관리 시

#### 문제: 자동 업데이트가 작동하지 않음

**확인 사항**:
1. Settings → 골든셋 자동 업데이트 활성화 확인
2. 승인된 샘플 ≥ 임계값 확인
3. 로그 확인: `docker-compose logs backend | grep "Auto-updated"`

#### 문제: 샘플이 추가되지 않음

**원인**:
- max_samples 도달
- 품질 기준 미달 (quality_score < min_quality_score)

**해결**:
1. max_samples 증가
2. min_quality_score 낮춤

---

## 권한별 가능한 작업

| 작업 | VIEWER | USER | OPERATOR | APPROVER | ADMIN |
|------|:------:|:----:|:--------:|:--------:|:-----:|
| 피드백 제공 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 샘플 조회 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 샘플 생성 | ❌ | ✅ | ✅ | ✅ | ✅ |
| 샘플 추출 | ❌ | ❌ | ✅ | ✅ | ✅ |
| 샘플 승인 | ❌ | ❌ | ❌ | ✅ | ✅ |
| 규칙 추출 | ❌ | ❌ | ❌ | ✅ | ✅ |
| 후보 승인 | ❌ | ❌ | ❌ | ✅ | ✅ |
| 샘플 삭제 | ❌ | ❌ | ❌ | ❌ | ✅ |
| 설정 변경 | ❌ | ❌ | ❌ | ❌ | ✅ |

---

## 성능 메트릭 이해하기

### Quality Score (품질 점수)

```
quality_score = (rating/5) × confidence × recency_factor

예시:
  - 5점 평가, 신뢰도 0.8, 1일 전 → 1.0 × 0.8 × 1.0 = 0.80
  - 4점 평가, 신뢰도 0.7, 15일 전 → 0.8 × 0.7 × 0.5 = 0.28
```

### Coverage (커버리지)

규칙이 처리할 수 있는 케이스의 비율

- **0.9 (90%)**: 매우 좋음 - 거의 모든 케이스 처리
- **0.7 (70%)**: 양호 - 대부분 케이스 처리
- **0.5 (50%)**: 부족 - 절반만 처리 가능
- **<0.5**: 샘플 부족 또는 규칙 단순함

### Precision (정밀도)

규칙이 "맞다"고 한 것 중 실제로 맞는 비율

- **0.9+**: 매우 신뢰 가능
- **0.8**: 양호 (프로덕션 배포 가능)
- **0.7**: 보통 (주의 필요)
- **<0.7**: 거짓 양성 많음 (규칙 개선 필요)

### F1 Score (종합 점수)

Precision과 Recall의 균형 지표

- **0.85+**: 우수 - 즉시 배포 가능
- **0.75-0.85**: 양호 - 테스트 후 배포
- **0.65-0.75**: 보통 - 추가 검증 필요
- **<0.65**: 부족 - 더 많은 샘플 필요

---

## 실전 시나리오

### 시나리오 1: 초기 설정 (샘플 0개)

**목표**: 첫 규칙 추출까지 도달

1. **Week 1**: 피드백 수집
   - 사용자에게 적극적인 피드백 요청
   - 특히 "수정 제안" 유도
   - 목표: 100+ 피드백

2. **Week 2**: 샘플 추출 및 승인
   - 자동 추출 활성화 (주기: 6시간)
   - Approver가 매일 샘플 검토
   - 목표: 50+ 승인된 샘플

3. **Week 3**: 첫 규칙 추출
   - 카테고리별 규칙 추출 시도
   - 테스트 후 승인
   - 목표: 첫 ProposedRule 생성

### 시나리오 2: 성능 개선 (기존 규칙 있음)

**목표**: 기존 규칙의 정확도 향상

1. 부정적 피드백 분석
   - Learning 페이지 → 피드백 통계
   - 어떤 케이스에서 오류 많은지 확인

2. 해당 케이스 샘플 집중 수집
   - 오류 케이스에 대한 피드백 유도
   - 수동 샘플 생성

3. 재학습
   - 새 샘플 포함하여 규칙 재추출
   - A/B 테스트로 기존 규칙과 비교

---

## 자주 묻는 질문 (FAQ)

**Q: 샘플은 언제 자동 추출되나요?**
A: Settings에서 "자동 추출 활성화" ON 시, 설정한 주기(기본 6시간)마다 자동 실행됩니다.

**Q: 승인된 샘플을 취소할 수 있나요?**
A: 네, 샘플 상세 모달에서 "거절"로 상태 변경 가능합니다 (Approver 권한 필요).

**Q: 골든셋은 왜 필요한가요?**
A: 고품질 샘플만 모아서 규칙 학습의 정확도를 높이기 위함입니다. 일반 샘플 pool보다 우선적으로 사용됩니다.

**Q: 규칙 추출 후 바로 배포되나요?**
A: 아니요. ProposedRule로 생성되며, Builder 페이지에서 최종 검토 후 배포 워크플로우를 거칩니다.

**Q: 여러 카테고리를 한 번에 학습할 수 있나요?**
A: 네, 카테고리를 null로 설정하면 전체 샘플로 학습합니다. 하지만 카테고리별 분리 학습이 더 정확합니다.

---

## 관련 문서

- [Learning Pipeline API Reference](../api/learning-pipeline.md)
- [RBAC User Guide](rbac-guide.md)
- [Sample Curation Service Spec](../specs/implementation/LRN-FR-020-Sample-Curation-Service.md)
- [Rule Extraction Service Spec](../specs/implementation/LRN-FR-030-Rule-Extraction-Service.md)
